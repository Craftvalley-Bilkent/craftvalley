{% extends 'user/userBase.html' %}

{% block styles %}
    <style>
        .product-container {
            display: flex;
            flex-wrap: wrap;
        }

        .product {
            width: calc(25% - 20px);
            margin: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .pagination.fixed-bottom {
            position: fixed;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: #fff; 
        }

        .pagination.justify-content-center {
            display: flex;
        }

        .mainPage-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            z-index: 110000; 
        }
    </style>
{% endblock %}

{% block content %}
    <div class="product-container">
        {% for product in products %}
            <div class="product" onclick="showProductPopup('{{ product.id }}', '{{ product.title|escapejs }}', '{{ product.description|escapejs }}', '{{ product.price }}', '{{ product.images }}')">
                <h3>{{ product.title }}</h3>
                <p>{{ product.description }}</p>
                <p>Price: ${{ product.price }}</p>
                {% if product.images %}
                    <img src="data:image/jpeg;base64,{{ product.images }}" alt="{{ product.title }}" style="min-height: 70%; max-height: 70%; min-width: 90%; max-width: 90%; margin-left: 5%;">
                {% endif %}
            </div>
        {% endfor %}
    </div>
    
    <div class="mainPage-popup" id="productPopup">
        
    </div>

    <!-- Pagination -->
    <div class="pagination-container fixed-bottom text-center mb-3 justify-content-center">
        <ul class="pagination justify-content-center">
            {% if current_page > 3 %}
                <li class="page-item">
                    <a class="page-link" href="?page=1">First</a>
                </li>
            {% endif %}
            {% for page_num in page_range %}
                {% if page_num >= current_page|add:"-2" and page_num <= current_page|add:"2" %}
                    <li class="page-item {% if page_num == current_page %}active{% endif %}">
                        <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            {% if current_page < total_pages|add:"-2" %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ total_pages }}">Last</a>
                </li>
            {% endif %}
        </ul>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const productsData = JSON.parse('{{ products|escapejs }}');

        $(document).ready(function() {
            $(document).on('click', '.pagination .page-link', function(e) {
                e.preventDefault();
                var page = $(this).attr('href').split('page=')[1];
                loadProducts(page);
            });

            $(document).on('click', function(e) {
                const popup = document.getElementById('productPopup');
                if (!popup.contains(e.target)) {
                    closePopup();
                }
            });
        });

        function loadProducts(page) {
            $.ajax({
                url: '/user/main',
                data: {'page': page},
                success: function(data) {
                    $('.product-container').html($(data).find('.product-container').html());
                    $('.pagination').html($(data).find('.pagination').html());
                }
            });
        }

        function showProductPopup(productId, title, description, price, images) {
            closePopup();
            const popup = document.getElementById('productPopup');
            popup.innerHTML = `
                <h3>${title}</h3>
                <p>${description}</p>
                <p>Price: $${price}</p>
                ${images ? `<img src="data:image/jpeg;base64,${images}" alt="${title}" style="width: 100%;">` : ''}
            `;
            popup.style.display = 'block';
        }
        function closePopup() {
            const popup = document.getElementById('productPopup');
            popup.innerHTML = '';
            popup.style.display = 'none';
        }
    </script>
{% endblock %}
